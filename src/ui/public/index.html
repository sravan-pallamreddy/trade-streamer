<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Streamer</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div class="flex flex-wrap items-center gap-6 sm:gap-8">
                    <img src="/logo.svg" alt="Trade Streamer" class="h-10 w-auto sm:h-12">
                </div>
                <div class="flex items-start gap-3">
                    <div class="text-right">
                        <div id="headerBalance" class="text-2xl font-bold text-green-600">$****</div>
                        <div class="text-sm text-gray-500">Account Balance</div>
                    </div>
                    <button id="toggleSensitiveBtn" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-gray-700 border border-gray-200 rounded-lg px-3 py-2 bg-white" type="button">
                        <i id="toggleSensitiveIcon" data-lucide="eye-off" class="w-4 h-4"></i>
                        <span id="toggleSensitiveLabel">Show Details</span>
                    </button>
                </div>
            </div>
            <h1 class="sr-only">Trade Streamer – AI Strategy Playbooks for Day Trading</h1>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col gap-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <button id="scanBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                        <i data-lucide="search" class="w-5 h-5"></i>
                        Scan for Trades
                    </button>
                    <button id="portfolioBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                        <i data-lucide="wallet" class="w-5 h-5"></i>
                        Load Portfolio
                    </button>
                    <div id="scanStatus" class="text-gray-600 flex items-center gap-2">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                        Waiting for first scan
                    </div>
                </div>
                <div class="w-full">
                    <label for="symbolsInput" class="text-sm font-semibold text-gray-700">Symbols to scan</label>
                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <input id="symbolsInput" type="text" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter comma-separated symbols e.g. SPY, QQQ, AAPL">
                        <button id="saveSymbolsBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Save Symbols
                        </button>
                    </div>
                    <div id="symbolsStatus" class="mt-2 text-sm text-gray-500 flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        Loading symbol list...
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="lg:grid lg:grid-cols-[1.35fr_1fr] gap-6 items-start">
            <div class="space-y-6">
                <div id="recommendations" class="space-y-4 max-h-[70vh] overflow-y-auto pr-1">
                    <!-- Recommendations will be inserted here -->
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 xl:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-3 rounded-full">
                                <i data-lucide="trending-up" class="w-5 h-5 text-green-600"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-lg font-bold text-green-600">$0</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide">Today's P&L</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i data-lucide="target" class="w-5 h-5 text-blue-600"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-lg font-bold text-blue-600">0</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide">Active Trades</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-lg font-bold text-yellow-600">$5</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide">Max Risk/Trade</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex items-center">
                            <div class="bg-purple-100 p-3 rounded-full">
                                <i data-lucide="zap" class="w-5 h-5 text-purple-600"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-lg font-bold text-purple-600">82%</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide">AI Confidence</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Section -->
            <div id="portfolioColumn" class="space-y-4">
                <div id="portfolioSection" class="bg-white rounded-lg shadow-md p-6 hidden max-h-[70vh] overflow-y-auto">
                    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <h2 class="text-2xl font-bold text-gray-800">Portfolio</h2>
                            <span id="portfolioStatus" class="text-xs text-gray-500"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="refreshPortfolioBtn" type="button" class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-200 rounded-lg px-3 py-2 bg-white">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>Refresh</span>
                            </button>
                            <select id="accountSelect" class="border border-gray-300 rounded px-3 py-2">
                                <option value="">Select Account</option>
                            </select>
                        </div>
                    </div>

                    <!-- Account Summary -->
                    <div id="accountSummary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <!-- Account summary will be inserted here -->
                    </div>

                    <!-- Positions Tables -->
                    <div class="space-y-8">
                        <!-- Options Section -->
                        <div id="optionsSection">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="zap" class="w-5 h-5 text-purple-600"></i>
                                Options
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full table-auto">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Price</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Market Value</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unrealized P&L</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P&L %</th>
                                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="optionsBody" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                                <div class="flex flex-col items-center">
                                                    <i data-lucide="zap" class="w-8 h-8 text-purple-400 mb-2"></i>
                                                    <div class="text-lg font-medium mb-2">Select an Account</div>
                                                    <div class="text-sm text-center max-w-md">
                                                        <div class="text-gray-400">Choose an account from the dropdown above to view options positions.</div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Stocks Section -->
                        <div id="stocksSection">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-5 h-5 text-green-600"></i>
                                Stocks
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full table-auto">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Price</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Market Value</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unrealized P&L</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P&L %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stocksBody" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                                <div class="flex flex-col items-center">
                                                    <i data-lucide="trending-up" class="w-8 h-8 text-green-400 mb-2"></i>
                                                    <div class="text-lg font-medium mb-2">Select an Account</div>
                                                    <div class="text-sm text-center max-w-md">
                                                        <div class="text-gray-400">Choose an account from the dropdown above to view stock positions.</div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        const scanBtn = document.getElementById('scanBtn');
        const scanStatus = document.getElementById('scanStatus');
        const recommendations = document.getElementById('recommendations');
        const portfolioBtn = document.getElementById('portfolioBtn');
        const portfolioSection = document.getElementById('portfolioSection');
        const accountSelect = document.getElementById('accountSelect');
        const accountSummary = document.getElementById('accountSummary');
        const stocksBody = document.getElementById('stocksBody');
        const optionsBody = document.getElementById('optionsBody');
        const stocksSection = document.getElementById('stocksSection');
        const optionsSection = document.getElementById('optionsSection');
        const headerBalance = document.getElementById('headerBalance');
        const toggleSensitiveBtn = document.getElementById('toggleSensitiveBtn');
        const refreshPortfolioBtn = document.getElementById('refreshPortfolioBtn');
        const portfolioStatus = document.getElementById('portfolioStatus');
        const symbolsInput = document.getElementById('symbolsInput');
        const saveSymbolsBtn = document.getElementById('saveSymbolsBtn');
        const symbolsStatus = document.getElementById('symbolsStatus');

        const POLL_INTERVAL_MS = 15000;
        const PORTFOLIO_REFRESH_INTERVAL_MS = 60000;
        let recommendationsTimer = null;
        let portfolioRefreshTimer = null;
        let currentSymbolList = [];
        let revealSensitive = false;
        let lastBalancePayload = null;
        let lastPortfolioPayload = null;
        let lastPortfolioBalance = null;
        let lastPortfolioRefreshAt = null;

        // Update header balance display
        function updateHeaderBalance(balanceData) {
            lastBalancePayload = balanceData || null;
            renderHeaderBalance();
        }

        function escapeHtml(text) {
            if (text == null) return '';
            return text.toString().replace(/[&<>"']/g, (char) => {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
                return map[char] || char;
            });
        }

        function normalizeSymbolInput(value) {
            if (!value) return [];
            const parts = Array.isArray(value) ? value : value.split(/[,\s]+/);
            const seen = new Set();
            const out = [];
            for (const raw of parts) {
                if (!raw) continue;
                const symbol = raw.toString().trim().toUpperCase();
                if (!symbol) continue;
                if (!/^[A-Z0-9.\-]{1,12}$/.test(symbol)) continue;
                if (seen.has(symbol)) continue;
                seen.add(symbol);
                out.push(symbol);
            }
            return out;
        }

        function formatSymbolSummary(list) {
            if (!Array.isArray(list) || list.length === 0) {
                return 'No symbols configured';
            }
            const preview = list.slice(0, 6);
            const suffix = list.length > preview.length ? '…' : '';
            const countLabel = `${list.length} symbol${list.length === 1 ? '' : 's'}`;
            return `${countLabel}: ${preview.join(', ')}${suffix}`;
        }

        function setSymbolsStatus(state, message) {
            if (!symbolsStatus) return;
            const states = {
                loading: { icon: 'loader', color: 'text-blue-600', iconClass: 'animate-spin' },
                success: { icon: 'check', color: 'text-green-600', iconClass: '' },
                error: { icon: 'x', color: 'text-red-600', iconClass: '' },
                warning: { icon: 'alert-triangle', color: 'text-yellow-600', iconClass: '' },
                info: { icon: 'info', color: 'text-gray-600', iconClass: '' }
            };
            const meta = states[state] || states.info;
            const iconHtml = `<i data-lucide="${meta.icon}" class="w-4 h-4 ${meta.iconClass}"></i>`;
            symbolsStatus.innerHTML = `
                <div class="flex items-center gap-2 text-sm ${meta.color}">
                    ${iconHtml}
                    <span>${escapeHtml(message)}</span>
                </div>
            `;
            lucide.createIcons();
        }

        const SENSITIVE_MASK = '****';

        function maskAccountId(value) {
            const str = value != null ? String(value) : 'N/A';
            if (!str || str === 'N/A') {
                return 'N/A';
            }
            const alphanumeric = str.replace(/[^A-Za-z0-9]/g, '');
            const tail = alphanumeric.slice(-4) || str.slice(-4) || '----';
            return `${SENSITIVE_MASK}${tail}`;
        }

        function getCurrencyString(value) {
            if (!Number.isFinite(value)) {
                return revealSensitive ? 'N/A' : `$${SENSITIVE_MASK}`;
            }
            const formatted = `$${value.toFixed(2)}`;
            return revealSensitive ? formatted : `$${SENSITIVE_MASK}`;
        }

        function getAccountIdString(value) {
            const str = value != null ? String(value) : 'N/A';
            return revealSensitive ? str : maskAccountId(str);
        }

        function renderHeaderBalance() {
            if (!headerBalance) return;
            const rawValue = lastBalancePayload?.totalAccountValue;
            const numericValue = Number(rawValue);
            const safeValue = Number.isFinite(numericValue) ? numericValue : null;
            headerBalance.textContent = getCurrencyString(safeValue);
        }

        function refreshPortfolioDisplay() {
            if (lastPortfolioPayload) {
                displayPortfolio(lastPortfolioPayload, lastPortfolioBalance, { skipStore: true });
            }
        }

        function getAccountOptionLabels(account) {
            const desc = account.accountDesc || 'Account';
            const accountId = account.accountId || account.accountIdKey || 'N/A';
            const mode = account.accountMode ? ` - ${account.accountMode}` : '';
            const fullLabel = `${desc} (${accountId})${mode}`;
            const maskedId = maskAccountId(accountId);
            const maskedLabel = `${desc} (${maskedId})${mode}`;
            return { fullLabel, maskedLabel };
        }

        function updateAccountSelectLabels(mode = 'auto') {
            if (!accountSelect) return;
            const desiredMode = mode === 'auto' ? (revealSensitive ? 'full' : 'masked') : mode;
            const useFull = desiredMode === 'full';
            Array.from(accountSelect.options).forEach(option => {
                if (!option.dataset || !option.dataset.fullLabel) return;
                const fullLabel = option.dataset.fullLabel;
                const maskedLabel = option.dataset.maskedLabel || fullLabel;
                option.textContent = useFull ? fullLabel : maskedLabel;
            });
            const selected = accountSelect.options[accountSelect.selectedIndex];
            if (selected && selected.dataset && selected.dataset.fullLabel) {
                const fullLabel = selected.dataset.fullLabel;
                const maskedLabel = selected.dataset.maskedLabel || fullLabel;
                const shouldShowFull = revealSensitive || useFull;
                selected.textContent = shouldShowFull ? fullLabel : maskedLabel;
            }
        }

        function setPortfolioStatus(message, tone = 'info') {
            if (!portfolioStatus) return;
            const toneClassMap = {
                info: 'text-gray-500',
                success: 'text-green-600',
                warning: 'text-amber-600',
                error: 'text-red-600',
            };
            portfolioStatus.textContent = message || '';
            portfolioStatus.classList.remove('text-gray-500', 'text-green-600', 'text-amber-600', 'text-red-600');
            if (message) {
                portfolioStatus.classList.add(toneClassMap[tone] || toneClassMap.info);
                portfolioStatus.classList.remove('hidden');
            } else {
                portfolioStatus.classList.add('hidden');
            }
        }

        function clearPortfolioRefreshTimer() {
            if (portfolioRefreshTimer) {
                clearInterval(portfolioRefreshTimer);
                portfolioRefreshTimer = null;
            }
        }

        function schedulePortfolioRefresh(accountIdKey) {
            clearPortfolioRefreshTimer();
            if (!accountIdKey) {
                return;
            }
            portfolioRefreshTimer = setInterval(() => {
                loadAccountDetails(accountIdKey, { showLoading: false, reason: 'auto' });
            }, PORTFOLIO_REFRESH_INTERVAL_MS);
        }

        function formatRefreshTimestamp(timestamp) {
            if (!timestamp) {
                return '';
            }
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        setPortfolioStatus('');

        function updateSensitiveControls() {
            if (!toggleSensitiveBtn) return;
            const iconName = revealSensitive ? 'eye' : 'eye-off';
            const label = revealSensitive ? 'Hide Details' : 'Show Details';
            toggleSensitiveBtn.innerHTML = `
                <i data-lucide="${iconName}" class="w-4 h-4"></i>
                <span>${label}</span>
            `;
            lucide.createIcons();
        }

        if (toggleSensitiveBtn) {
            updateSensitiveControls();
            toggleSensitiveBtn.addEventListener('click', () => {
                revealSensitive = !revealSensitive;
                updateSensitiveControls();
                renderHeaderBalance();
                refreshPortfolioDisplay();
                updateAccountSelectLabels();
            });
        }

        function applyScanConfig(config, options = {}) {
            const { updateInput = false, updateStatus = true } = options;
            if (!config) return;
            const list = Array.isArray(config.symbols) ? config.symbols : [];
            currentSymbolList = list;
            if (updateInput && symbolsInput && document.activeElement !== symbolsInput) {
                symbolsInput.value = list.join(', ');
            }
            if (updateStatus) {
                if (list.length === 0) {
                    setSymbolsStatus('warning', 'No symbols configured. Add tickers to start scanning.');
                } else {
                    setSymbolsStatus('info', formatSymbolSummary(list));
                }
            }
        }

        function renderScanStatus({ icon, color = 'text-gray-600', message, suffix = '', iconClass = '' }) {
            if (!scanStatus) return;
            scanStatus.innerHTML = `
                <div class="flex items-center gap-2 ${color}">
                    <i data-lucide="${icon}" class="w-4 h-4 ${iconClass}"></i>
                    <span>${escapeHtml(message)}</span>
                    ${suffix}
                </div>
            `;
            lucide.createIcons();
        }

        function formatRelativeTime(isoString) {
            if (!isoString) {
                return 'never';
            }

            const deltaMs = Date.now() - Date.parse(isoString);
            if (!Number.isFinite(deltaMs) || deltaMs < 0) {
                return new Date(isoString).toLocaleTimeString();
            }

            const seconds = Math.floor(deltaMs / 1000);
            if (seconds < 60) {
                return `${seconds}s ago`;
            }

            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) {
                return `${minutes}m ago`;
            }

            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }

        function updateScanStatus(payload, error) {
            if (payload?.config) {
                applyScanConfig(payload.config, { updateInput: false, updateStatus: true });
            }

            const symbolSuffix = currentSymbolList.length
                ? `<span class="text-xs text-gray-400 ml-2">[${escapeHtml(currentSymbolList.join(', '))}]</span>`
                : '';

            if (error) {
                renderScanStatus({ icon: 'x', color: 'text-red-600', message: error, suffix: symbolSuffix });
                return;
            }

            if (!payload) {
                renderScanStatus({ icon: 'clock', message: 'Waiting for first scan', suffix: symbolSuffix });
                return;
            }

            const { isScanning, scanMeta, lastError } = payload;

            if (isScanning) {
                renderScanStatus({ icon: 'loader', color: 'text-blue-600', iconClass: 'animate-spin', message: 'Running day-trade scan...', suffix: symbolSuffix });
                return;
            }

            if (scanMeta?.success) {
                const completed = formatRelativeTime(scanMeta.completedAt);
                const sourceLabel = scanMeta.source || 'auto';
                renderScanStatus({
                    icon: 'check',
                    color: 'text-green-600',
                    message: `Last scan ${completed} (${sourceLabel})`,
                    suffix: symbolSuffix
                });
                return;
            }

            if (scanMeta && !scanMeta.success) {
                const completed = formatRelativeTime(scanMeta.completedAt);
                const errorMessage = lastError?.message || 'Scan failed';
                renderScanStatus({
                    icon: 'alert-triangle',
                    color: 'text-yellow-600',
                    message: `Scan error ${completed}: ${errorMessage}`,
                    suffix: symbolSuffix
                });
                return;
            }

            renderScanStatus({ icon: 'clock', message: 'Waiting for first scan', suffix: symbolSuffix });
        }

        async function fetchRecommendations() {
            try {
                const response = await fetch('/api/recommendations');
                const data = await response.json();

                if (data.results) {
                    displayRecommendations(data.results.parsed);
                }

                updateScanStatus(data);
            } catch (err) {
                console.error('Failed to fetch recommendations:', err);
                updateScanStatus(null, 'Disconnected from scanner');
            }
        }

        function startRecommendationsPolling() {
            if (recommendationsTimer) {
                return;
            }

            recommendationsTimer = setInterval(fetchRecommendations, POLL_INTERVAL_MS);
        }

        // Scan for trades
        scanBtn.addEventListener('click', async () => {
            scanBtn.disabled = true;
            scanBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Scanning...';
            lucide.createIcons();
            const suffix = currentSymbolList.length
                ? `<span class="text-xs text-gray-400 ml-2">[${escapeHtml(currentSymbolList.join(', '))}]</span>`
                : '';
            renderScanStatus({ icon: 'loader', color: 'text-blue-600', iconClass: 'animate-spin', message: 'Running manual scan...', suffix });

            try {
                const response = await fetch('/api/scan', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    await fetchRecommendations();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Scan failed:', error);
                const alreadyRunning = error.message === 'Scan already in progress';
                const msg = alreadyRunning ? 'Scan already running, please wait...' : 'Manual scan failed: ' + error.message;
                updateScanStatus(null, msg);
            } finally {
                scanBtn.disabled = false;
                scanBtn.innerHTML = '<i data-lucide="search" class="w-5 h-5"></i> Scan for Trades';
                lucide.createIcons();
            }
        });

        if (saveSymbolsBtn) {
            saveSymbolsBtn.addEventListener('click', async () => {
                await saveSymbols();
            });
        }

        if (symbolsInput) {
            symbolsInput.addEventListener('keydown', async (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    await saveSymbols();
                }
            });
        }

        // Load portfolio
        portfolioBtn.addEventListener('click', async () => {
            portfolioBtn.disabled = true;
            portfolioBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Loading...';

            try {
                // First get accounts
                const accountsResponse = await fetch('/api/portfolio/accounts');
                const accountsData = await accountsResponse.json();

                if (!accountsData.success || !accountsData.accounts.length) {
                    throw new Error('No accounts found. Please check E*TRADE authentication.');
                }

                // Store accounts data for later use
                window.availableAccounts = accountsData.accounts;

                // Populate account selector
                accountSelect.innerHTML = '<option value="">Select Account</option>';
                accountsData.accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.accountIdKey;
                    const labels = getAccountOptionLabels(account);
                    option.dataset.fullLabel = labels.fullLabel;
                    option.dataset.maskedLabel = labels.maskedLabel;
                    option.textContent = revealSensitive ? labels.fullLabel : labels.maskedLabel;
                    accountSelect.appendChild(option);
                });

                updateAccountSelectLabels();
                clearPortfolioRefreshTimer();
                updateHeaderBalance(null);
                window.selectedAccountIdKey = null;
                setPortfolioStatus('Select an account to view details');

                portfolioSection.classList.remove('hidden');
                scanStatus.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-600"></i> Portfolio loaded - Select an account to view details';

            } catch (error) {
                console.error('Portfolio load error:', error);
                scanStatus.innerHTML = '<i data-lucide="x" class="w-4 h-4 text-red-600"></i> Portfolio error: ' + error.message;
                setPortfolioStatus('Portfolio load failed: ' + error.message, 'error');
            } finally {
                portfolioBtn.disabled = false;
                portfolioBtn.innerHTML = '<i data-lucide="wallet" class="w-5 h-5"></i> Load Portfolio';
                lucide.createIcons();
            }
        });

        accountSelect.addEventListener('mousedown', (event) => {
            if (event.button !== 0) return;
            updateAccountSelectLabels('full');
        });

        accountSelect.addEventListener('click', () => {
            updateAccountSelectLabels();
        });

        accountSelect.addEventListener('keydown', (event) => {
            const keysThatOpen = ['ArrowDown', 'ArrowUp', 'Enter', ' ', 'Space', 'Spacebar'];
            if (!keysThatOpen.includes(event.key)) return;
            updateAccountSelectLabels('full');
        });

        accountSelect.addEventListener('keyup', (event) => {
            if (['Escape', 'Enter', ' ', 'Space', 'Spacebar'].includes(event.key)) {
                updateAccountSelectLabels();
            }
        });

        accountSelect.addEventListener('blur', () => {
            updateAccountSelectLabels();
        });

        // Account selection change
        accountSelect.addEventListener('change', async (e) => {
            updateAccountSelectLabels();
            const accountIdKey = e.target.value;
            window.selectedAccountIdKey = accountIdKey || null;
            clearPortfolioRefreshTimer();

            if (!accountIdKey) {
                updateHeaderBalance(null); // Reset balance display when no account selected
                setPortfolioStatus('Select an account to view details');
                return;
            }

            await loadAccountDetails(accountIdKey, { showLoading: true, reason: 'manual' });
            schedulePortfolioRefresh(accountIdKey);
        });

        async function loadAccountDetails(accountIdKey, { showLoading = true, reason = 'manual' } = {}) {
            if (!accountIdKey) {
                return false;
            }

            if (showLoading) {
                accountSummary.innerHTML = `
                    <div class="col-span-4 flex items-center justify-center py-8">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="loader" class="w-5 h-5 animate-spin text-blue-600"></i>
                            <span class="text-gray-600">Loading account details...</span>
                        </div>
                    </div>
                `;
                stocksBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <i data-lucide="loader" class="w-5 h-5 animate-spin mx-auto mb-2"></i>
                            <div>Loading stock positions...</div>
                        </td>
                    </tr>
                `;
                optionsBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <i data-lucide="loader" class="w-5 h-5 animate-spin mx-auto mb-2"></i>
                            <div>Loading options positions...</div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                setPortfolioStatus('Loading account data...', 'info');
            } else {
                setPortfolioStatus(reason === 'auto' ? 'Auto refresh in progress…' : 'Refreshing portfolio…', 'info');
            }

            try {
                let balanceData = null;
                try {
                    const balanceResponse = await fetch(`/api/portfolio/${accountIdKey}/balance`);
                    if (balanceResponse.ok) {
                        const balanceResult = await balanceResponse.json();
                        if (balanceResult.success) {
                            balanceData = balanceResult.balance;
                        }
                    }
                } catch (balanceErr) {
                    console.log('Balance API not available, continuing with basic info');
                }

                const portfolioResponse = await fetch(`/api/portfolio/${accountIdKey}`);
                const portfolioData = await portfolioResponse.json();

                if (!portfolioData.success) {
                    throw new Error(portfolioData.error || 'Failed to load portfolio');
                }

                displayPortfolio(portfolioData.portfolio, balanceData);
                updateHeaderBalance(balanceData);
                lastPortfolioRefreshAt = Date.now();
                const label = reason === 'auto' ? 'Auto refreshed' : 'Updated';
                const suffix = reason === 'auto' ? '' : ' · auto refresh every 60s';
                setPortfolioStatus(`${label} at ${formatRefreshTimestamp(lastPortfolioRefreshAt)}${suffix}`, 'success');
                return true;
            } catch (error) {
                console.error('Account fetch error:', error);
                const accountDetails = window.availableAccounts?.find((acc) => acc.accountIdKey === accountIdKey);
                if (accountDetails) {
                    displayBasicAccountInfo(accountDetails);
                    updateHeaderBalance(null);
                } else {
                    accountSummary.innerHTML = `
                        <div class="col-span-4 text-center py-8">
                            <i data-lucide="alert-triangle" class="w-8 h-8 text-red-500 mx-auto mb-2"></i>
                            <div class="text-red-600 font-medium">Error Loading Account</div>
                            <div class="text-sm text-gray-500 mt-1">${escapeHtml(error.message)}</div>
                        </div>
                    `;
                }

                stocksBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <i data-lucide="alert-triangle" class="w-8 h-8 text-red-500 mx-auto mb-2"></i>
                            <div class="text-red-600">Error loading positions</div>
                        </td>
                    </tr>
                `;
                optionsBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <i data-lucide="alert-triangle" class="w-8 h-8 text-red-500 mx-auto mb-2"></i>
                            <div class="text-red-600">Error loading positions</div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                setPortfolioStatus(`Portfolio refresh failed: ${error.message}`, 'error');
                return false;
            }
        }

        if (refreshPortfolioBtn) {
            refreshPortfolioBtn.addEventListener('click', async () => {
                if (!window.selectedAccountIdKey) {
                    setPortfolioStatus('Select an account before refreshing', 'warning');
                    return;
                }
                await loadAccountDetails(window.selectedAccountIdKey, { showLoading: false, reason: 'manual' });
                schedulePortfolioRefresh(window.selectedAccountIdKey);
            });
        }

        window.addEventListener('beforeunload', () => {
            clearPortfolioRefreshTimer();
        });

        if (optionsBody) {
            optionsBody.addEventListener('click', async (event) => {
                const button = event.target.closest('button[data-action]');
                if (!button) {
                    return;
                }

                const action = button.dataset.action;
                if (action !== 'emergency-sell') {
                    return;
                }

                event.preventDefault();
                const accountIdKey = window.selectedAccountIdKey;
                if (!accountIdKey) {
                    alert('Select an account before submitting an emergency sell.');
                    return;
                }

                const optionSymbol = button.dataset.optionSymbol || button.dataset.symbol;
                const quantity = Number(button.dataset.quantity);
                if (!optionSymbol) {
                    alert('Missing option symbol for this position.');
                    return;
                }
                if (!Number.isFinite(quantity) || quantity === 0) {
                    alert('Unable to determine position size for emergency sell.');
                    return;
                }

                const callPut = button.dataset.callPut || null;
                const strike = button.dataset.strike !== '' ? Number(button.dataset.strike) : null;
                const expiry = button.dataset.expiry || null;
                const positionId = button.dataset.positionId || null;

                const confirmationLines = [
                    `Account: ${accountIdKey}`,
                    `Option: ${optionSymbol}`,
                    `Quantity: ${quantity}`,
                    '',
                    'This will submit a market exit at the current market price immediately.',
                    'Existing stop or limit orders are not automatically cancelled.',
                    'Continue?',
                ];

                if (!window.confirm(confirmationLines.join('\n'))) {
                    return;
                }

                const payload = {
                    optionSymbol,
                    symbol: button.dataset.symbol || optionSymbol,
                    quantity,
                    positionId,
                    callPut,
                    strike: Number.isFinite(strike) ? strike : null,
                    expiry,
                };

                const originalLabel = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>';
                lucide.createIcons();

                try {
                    const response = await fetch(`/api/portfolio/${accountIdKey}/options/emergency-sell`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    let data = null;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        data = null;
                    }

                    if (!response.ok || !data?.success) {
                        const errorMessage = data?.error || `Broker rejected order (HTTP ${response.status})`;
                        throw new Error(errorMessage);
                    }

                    const messageLines = ['Emergency sell submitted successfully.'];
                    if (data.order?.orderId) {
                        messageLines.push(`Order ID: ${data.order.orderId}`);
                    }
                    if (data.order?.previewId) {
                        messageLines.push(`Preview ID: ${data.order.previewId}`);
                    }
                    if (Array.isArray(data.order?.messages) && data.order.messages.length) {
                        messageLines.push(`Broker notes: ${data.order.messages.join('; ')}`);
                    }

                    alert(messageLines.join('\n'));

                    if (accountSelect) {
                        accountSelect.dispatchEvent(new Event('change'));
                    }
                } catch (err) {
                    alert(`Emergency sell failed: ${err.message}`);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalLabel;
                    lucide.createIcons();
                }
            });
        }

        // Display recommendations
        function displayRecommendations(recs) {
            recommendations.innerHTML = '';

            const formatStrategyScore = (score) => {
                if (!Number.isFinite(score)) {
                    return null;
                }
                const normalized = score <= 1 ? score * 100 : score;
                return `${Math.round(normalized)}%`;
            };

            const normalizeBias = (bias) => {
                if (!bias) {
                    return 'neutral';
                }
                return String(bias).replace(/[_-]+/g, ' ');
            };

            const formatAdjustmentValue = (value) => {
                if (value == null) {
                    return '<span class="text-gray-400">n/a</span>';
                }
                if (typeof value === 'string') {
                    return escapeHtml(value);
                }
                if (typeof value === 'number') {
                    const formatted = Number.isFinite(value) ? value.toFixed(value % 1 === 0 ? 0 : 2) : String(value);
                    return escapeHtml(formatted);
                }
                if (Array.isArray(value)) {
                    return value
                        .map((item) => typeof item === 'string' ? escapeHtml(item) : escapeHtml(JSON.stringify(item)))
                        .join(', ');
                }
                return escapeHtml(JSON.stringify(value));
            };

            if (!recs || recs.length === 0) {
                recommendations.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-6 text-center">
                        <i data-lucide="alert-circle" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600">No Recommendations</h3>
                        <p class="text-gray-500">Market conditions not favorable for trades today.</p>
                    </div>
                `;
                return;
            }

            recs.forEach((rec, idx) => {
                const decision = rec.ai?.decision || 'unknown';
                const confidence = rec.ai?.confidence || (Number.isFinite(rec.ai?.strength) ? `${rec.ai.strength}%` : 'N/A');
                const icon = decision === 'approve' ? 'check-circle' :
                           decision === 'caution' ? 'alert-triangle' : 'x-circle';

                const iconColor = decision === 'approve' ? 'text-green-600' :
                                decision === 'caution' ? 'text-yellow-600' : 'text-red-600';

                const entryBlock = Number.isFinite(rec.entry) || Number.isFinite(rec.stop) || Number.isFinite(rec.target)
                    ? `
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-lg font-bold text-blue-600">${Number.isFinite(rec.entry) ? `$${rec.entry.toFixed(2)}` : 'N/A'}</div>
                                <div class="text-sm text-gray-600">Entry</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-red-600">${Number.isFinite(rec.stop) ? `$${rec.stop.toFixed(2)}` : 'N/A'}</div>
                                <div class="text-sm text-gray-600">Stop Loss</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-green-600">${Number.isFinite(rec.target) ? `$${rec.target.toFixed(2)}` : 'N/A'}</div>
                                <div class="text-sm text-gray-600">Target</div>
                            </div>
                        </div>
                    ` : '';

                const sizingBlock = Number.isFinite(rec.qty) || Number.isFinite(rec.risk) || Number.isFinite(rec.riskPerContract)
                    ? `
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-lg font-bold text-indigo-600">${Number.isFinite(rec.qty) ? rec.qty : 'N/A'}</div>
                                <div class="text-sm text-gray-600">Contracts</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-amber-600">${Number.isFinite(rec.risk) ? `$${rec.risk.toFixed(2)}` : 'N/A'}</div>
                                <div class="text-sm text-gray-600">Risk Budget</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-purple-600">${Number.isFinite(rec.riskPerContract) ? `$${rec.riskPerContract.toFixed(2)}` : 'N/A'}</div>
                                <div class="text-sm text-gray-600">Per Contract</div>
                            </div>
                        </div>
                    ` : '';

                const selectedStrategy = rec.ai?.selectedStrategy;
                const strategyBlock = selectedStrategy
                    ? `
                        <div class="border border-indigo-100 bg-indigo-50 rounded-lg p-4">
                            <div class="text-sm font-semibold text-indigo-700 mb-1 flex items-center gap-2">
                                <i data-lucide="compass" class="w-4 h-4 text-indigo-600"></i>
                                Strategy Alignment
                            </div>
                            <div class="flex flex-wrap items-center gap-3 text-sm text-indigo-900">
                                <span class="font-semibold">${escapeHtml(selectedStrategy.name || 'Primary')}</span>
                                <span class="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 text-xs font-semibold uppercase tracking-wide">${escapeHtml(normalizeBias(selectedStrategy.bias || 'neutral'))}</span>
                                ${formatStrategyScore(selectedStrategy.score) ? `<span class="text-xs text-indigo-700">Score ${formatStrategyScore(selectedStrategy.score)}</span>` : ''}
                            </div>
                            ${selectedStrategy.rationale ? `<div class="text-xs text-gray-600 mt-2">${escapeHtml(selectedStrategy.rationale)}</div>` : ''}
                        </div>
                    `
                    : '';

                const riskFlags = Array.isArray(rec.ai?.riskFlags) ? rec.ai.riskFlags.filter(Boolean) : [];
                const riskBlock = riskFlags.length
                    ? `
                        <div class="border border-red-100 bg-red-50 rounded-lg p-4">
                            <div class="text-sm font-semibold text-red-700 mb-2 flex items-center gap-2">
                                <i data-lucide="shield-alert" class="w-4 h-4 text-red-600"></i>
                                Risk Flags
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${riskFlags.map(flag => `<span class="inline-flex items-center px-2.5 py-1 rounded-full bg-red-100 text-red-700 text-xs font-medium">${escapeHtml(flag)}</span>`).join('')}
                            </div>
                        </div>
                    `
                    : '';

                const adjustmentsEntries = rec.ai?.adjustments && typeof rec.ai.adjustments === 'object'
                    ? Object.entries(rec.ai.adjustments).filter(([, value]) => value != null)
                    : [];

                const adjustmentsBlock = adjustmentsEntries.length
                    ? `
                        <div class="border border-amber-100 bg-amber-50 rounded-lg p-4">
                            <div class="text-sm font-semibold text-amber-700 mb-2 flex items-center gap-2">
                                <i data-lucide="settings-2" class="w-4 h-4 text-amber-600"></i>
                                Suggested Adjustments
                            </div>
                            <div class="space-y-2">
                                ${adjustmentsEntries.map(([key, value]) => `
                                    <div>
                                        <div class="text-xs uppercase text-amber-600 font-semibold tracking-wide">${escapeHtml(String(key).replace(/[_-]+/g, ' '))}</div>
                                        <div class="text-sm text-gray-700">${formatAdjustmentValue(value)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `
                    : '';

                const strikeLabel = Number.isFinite(rec.strike)
                    ? `$${rec.strike.toFixed(rec.strike % 1 === 0 ? 0 : 2)}`
                    : 'N/A';
                const optionSourceLabel = rec.optionSource
                    ? escapeHtml(String(rec.optionSource).replace(/[_-]+/g, ' '))
                    : '<span class="text-gray-400">unknown</span>';

                const optionDetailsBlock = rec.contract
                    ? `
                        <div class="border border-slate-200 bg-slate-50 rounded-lg p-4">
                            <div class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                <i data-lucide="ticket" class="w-4 h-4 text-slate-500"></i>
                                Option Contract
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm text-slate-700">
                                <div>
                                    <div class="text-xs text-slate-500 uppercase tracking-wide">Contract</div>
                                    <div class="font-semibold">${escapeHtml(rec.contract)}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 uppercase tracking-wide">Type</div>
                                    <div class="font-semibold">${escapeHtml((rec.side || 'N/A').toUpperCase())}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-500 uppercase tracking-wide">Strike</div>
                                    <div class="font-semibold">${strikeLabel}</div>
                                </div>
                                <div class="col-span-2 md:col-span-3">
                                    <div class="text-xs text-slate-500 uppercase tracking-wide">Source</div>
                                    <div class="font-semibold">${optionSourceLabel}</div>
                                </div>
                            </div>
                        </div>
                    `
                    : '';

                const planSteps = Array.isArray(rec.scalingPlan) ? rec.scalingPlan
                    .sort((a, b) => a.step - b.step)
                    .map(step => {
                        const targetLabel = step.target != null ? `$${step.target.toFixed(2)}` : escapeHtml(step.targetLabel || 'Market strength');
                        return `
                            <div class="flex items-start gap-3 text-sm text-gray-700">
                                <div class="font-semibold text-gray-900">${step.step}.</div>
                                <div>
                                    <div class="font-medium">Sell ${step.sellQty} @ ${targetLabel}</div>
                                    <div class="text-xs text-gray-500">${escapeHtml(step.note)}</div>
                                </div>
                            </div>
                        `;
                    }).join('') : '';

                const planBlock = planSteps
                    ? `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                <i data-lucide="layers" class="w-4 h-4 text-gray-500"></i>
                                Scaling Plan
                            </div>
                            <div class="space-y-2">
                                ${planSteps}
                            </div>
                        </div>
                    ` : '';

                const warningBlock = rec.warning
                    ? `
                        <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-4 flex items-start gap-3">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 mt-0.5"></i>
                            <div class="text-sm text-yellow-800">${escapeHtml(rec.warning)}</div>
                        </div>
                    ` : '';

                const notesBlock = rec.ai?.notes
                    ? `
                        <div class="bg-white border border-blue-100 rounded-lg p-4">
                            <div class="text-sm font-semibold text-blue-700 mb-1 flex items-center gap-2">
                                <i data-lucide="message-circle" class="w-4 h-4 text-blue-500"></i>
                                AI Notes
                            </div>
                            <div class="text-sm text-gray-700">${escapeHtml(rec.ai.notes)}</div>
                        </div>
                    ` : '';

                const signalText = rec.signals?.length ? rec.signals.map(signal => escapeHtml(signal)).join(', ') : 'No signals';
                const symbolLabel = escapeHtml(rec.symbol || 'UNKNOWN');
                const borderAccent = decision === 'approve' ? 'border-l-4 border-green-200' : decision === 'caution' ? 'border-l-4 border-yellow-200' : 'border-l-4 border-red-200';

                const actionButtons = `
                        <div class="flex flex-wrap gap-2">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2">
                                <i data-lucide="play" class="w-4 h-4"></i>
                                Execute Trade
                            </button>
                            <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded flex items-center gap-2">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                View Chart
                            </button>
                        </div>
                `;

                const leftColumn = [strategyBlock, riskBlock, warningBlock, notesBlock, adjustmentsBlock].filter(Boolean).join('');
                const rightColumn = [optionDetailsBlock, entryBlock, sizingBlock].filter(Boolean).join('');
                const columnsClass = leftColumn && rightColumn ? 'md:grid-cols-2' : 'md:grid-cols-1';
                const leftColumnHtml = leftColumn ? `<div class="space-y-4">${leftColumn}</div>` : '';
                const rightColumnHtml = rightColumn ? `<div class="space-y-4">${rightColumn}</div>` : '';
                const columnsBlock = leftColumnHtml || rightColumnHtml
                    ? `
                        <div class="grid grid-cols-1 ${columnsClass} gap-4">
                            ${leftColumnHtml}
                            ${rightColumnHtml}
                        </div>
                    `
                    : '';

                const extraId = `rec-extra-${idx}`;
                const moreSection = planBlock
                    ? `
                        <div class="border-t border-gray-100 pt-3">
                            <button type="button" class="text-sm font-semibold text-blue-600 hover:text-blue-700 focus:outline-none flex items-center gap-2" data-extra-target="${extraId}" aria-expanded="false">
                                <span data-toggle-label>Show Scaling Plan</span>
                            </button>
                            <div id="${extraId}" class="hidden mt-3 space-y-3">
                                ${planBlock}
                            </div>
                        </div>
                    `
                    : '';

                recommendations.innerHTML += `
                    <div class="bg-white rounded-lg shadow-md border border-gray-100 ${borderAccent} p-5 space-y-4">
                        <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
                            <div class="flex items-start gap-3">
                                <i data-lucide="${icon}" class="w-6 h-6 ${iconColor}"></i>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">${symbolLabel}</h3>
                                    <p class="text-xs text-gray-500">${signalText || 'No signals'}</p>
                                </div>
                            </div>
                            <div class="text-left md:text-right">
                                <div class="text-sm font-semibold ${decision === 'approve' ? 'text-green-600' : decision === 'caution' ? 'text-yellow-600' : 'text-red-600'}">${decision.toUpperCase()}</div>
                                <div class="text-xs text-gray-500">Confidence: ${confidence}</div>
                            </div>
                        </div>
                        ${columnsBlock}
                        ${moreSection}
                        <div class="pt-3 border-t border-gray-100">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            });

            const toggleButtons = recommendations.querySelectorAll('[data-extra-target]');
            toggleButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const target = document.getElementById(btn.dataset.extraTarget);
                    if (!target) return;
                    const nowHidden = target.classList.toggle('hidden');
                    btn.setAttribute('aria-expanded', String(!nowHidden));
                    const label = btn.querySelector('[data-toggle-label]');
                    if (label) {
                        label.textContent = nowHidden ? 'Show Scaling Plan' : 'Hide Scaling Plan';
                    }
                });
            });

            lucide.createIcons();
        }

        // Display portfolio
        function displayPortfolio(portfolio, balanceData = null, { skipStore = false } = {}) {
            if (!skipStore) {
                lastPortfolioPayload = portfolio;
                lastPortfolioBalance = balanceData || null;
            }
            // Find the account details from the stored accounts list
            const accountDetails = window.availableAccounts?.find(acc => acc.accountIdKey === portfolio.account.accountIdKey);

            const primaryAccountId = accountDetails?.accountId || balanceData?.accountId || portfolio.account?.accountId || 'N/A';
            const maskedAccountId = escapeHtml(getAccountIdString(primaryAccountId));

            // Update account summary with available information
            let balanceHtml = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Account ID</div>
                    <div class="text-lg font-bold text-blue-600">${maskedAccountId}</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Account Type</div>
                    <div class="text-lg font-bold text-green-600">${accountDetails?.accountType || 'INDIVIDUAL'}</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Account Mode</div>
                    <div class="text-lg font-bold text-purple-600">${accountDetails?.accountMode || 'CASH'}</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Status</div>
                    <div class="text-lg font-bold text-orange-600">${accountDetails?.accountStatus || 'ACTIVE'}</div>
                </div>
            `;

            // Add balance information if available
            if (balanceData) {
                // For cash accounts, use moneyMktBalance or cashAvailableForInvestment
                const availableCash = Number(balanceData.moneyMktBalance ?? balanceData.cashAvailableForInvestment ?? balanceData.cashBalance ?? 0);
                const totalValue = Number(balanceData.totalAccountValue ?? 0);
                const buyingPower = Number(balanceData.cashBuyingPower ?? balanceData.marginBuyingPower ?? 0);

                const accountIdDisplay = escapeHtml(getAccountIdString(balanceData.accountId || primaryAccountId));
                const availableCashDisplay = escapeHtml(getCurrencyString(availableCash));
                const totalValueDisplay = escapeHtml(getCurrencyString(totalValue));
                const buyingPowerDisplay = escapeHtml(getCurrencyString(buyingPower));

                balanceHtml = `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Account ID</div>
                        <div class="text-lg font-bold text-blue-600">${accountIdDisplay}</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Available Cash</div>
                        <div class="text-lg font-bold text-green-600">${availableCashDisplay}</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Total Value</div>
                        <div class="text-lg font-bold text-purple-600">${totalValueDisplay}</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Buying Power</div>
                        <div class="text-lg font-bold text-orange-600">${buyingPowerDisplay}</div>
                    </div>
                `;
            }

            accountSummary.innerHTML = balanceHtml;

            // Separate positions into stocks and options
            const stocks = [];
            const options = [];

            if (portfolio.positions && portfolio.positions.length > 0) {
                // Check if positions are real or placeholder
                const hasRealPositions = portfolio.positions.some(pos => pos.symbol !== 'UNKNOWN' && pos.symbol !== '');

                if (hasRealPositions) {
                    portfolio.positions.forEach(position => {
                        // Check if it's an option by looking for option indicators in the symbol or description
                        const isOption = position.symbol.includes(' ') ||
                                       position.symbolDescription?.toLowerCase().includes('call') ||
                                       position.symbolDescription?.toLowerCase().includes('put') ||
                                       position.symbolDescription?.toLowerCase().includes('option') ||
                                       position.symbol?.match(/\d{6}[CP]\d+/); // Option symbol pattern

                        if (isOption) {
                            options.push(position);
                        } else {
                            stocks.push(position);
                        }
                    });
                } else {
                    // No real positions available - show message in stocks section
                    const balanceDisplay = escapeHtml(getCurrencyString(Number(balanceData?.totalAccountValue ?? 0)));
                    const cashDisplay = escapeHtml(getCurrencyString(Number(balanceData?.moneyMktBalance ?? balanceData?.cashAvailableForInvestment ?? 0)));
                    stocksBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i data-lucide="info" class="w-8 h-8 text-blue-400 mb-2"></i>
                                    <div class="text-lg font-medium mb-2">Account Connected Successfully</div>
                                    <div class="text-sm text-center max-w-md">
                                        <div class="mb-2">✅ <strong>Account:</strong> ${accountDetails?.accountDesc || 'Individual Brokerage'}</div>
                                        <div class="mb-2">✅ <strong>Balance Available:</strong> ${balanceDisplay}</div>
                                        <div class="mb-2">✅ <strong>Cash Available:</strong> ${cashDisplay}</div>
                                        <div class="mb-3">✅ <strong>Status:</strong> ${accountDetails?.accountStatus || 'ACTIVE'}</div>
                                        <div class="text-xs text-gray-400 bg-gray-100 p-2 rounded">
                                            <strong>Note:</strong> Position details are not available through the E*TRADE API for this account type. Balance information is available above. This is normal for many brokerage accounts.
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    optionsBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i data-lucide="info" class="w-8 h-8 text-blue-400 mb-2"></i>
                                    <div class="text-lg font-medium mb-2">No Options Positions</div>
                                    <div class="text-sm text-center max-w-md">
                                        <div class="text-gray-400">No options positions found in this account.</div>
                                        <div class="text-xs text-gray-400 mt-2">Options positions will appear here when available.</div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                    return; // Exit early since we're showing the account info message
                }
            }

            // Display stocks
            stocksBody.innerHTML = '';
            if (stocks.length > 0) {
                stocks.forEach(position => {
                    const pnlClass = position.unrealizedGainLoss >= 0 ? 'text-green-600' : 'text-red-600';
                    const pnlPercentClass = position.unrealizedGainLossPercent >= 0 ? 'text-green-600' : 'text-red-600';

                    stocksBody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${position.symbol}</div>
                                <div class="text-sm text-gray-500">${position.symbolDescription || ''}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                ${position.quantity}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                $${position.currentPrice.toFixed(2)}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                $${position.marketValue.toFixed(2)}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm ${pnlClass}">
                                $${position.unrealizedGainLoss.toFixed(2)}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm ${pnlPercentClass}">
                                ${position.unrealizedGainLossPercent.toFixed(2)}%
                            </td>
                        </tr>
                    `;
                });
            } else {
                stocksBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i data-lucide="trending-up" class="w-8 h-8 text-green-400 mb-2"></i>
                                <div class="text-lg font-medium mb-2">No Stock Positions</div>
                                <div class="text-sm text-center max-w-md">
                                    <div class="text-gray-400">No stock positions found in this account.</div>
                                    <div class="text-xs text-gray-400 mt-2">Stock positions will appear here when available.</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }

            // Display options
            optionsBody.innerHTML = '';
            if (options.length > 0) {
                options.forEach(position => {
                    const pnlClass = position.unrealizedGainLoss >= 0 ? 'text-green-600' : 'text-red-600';
                    const pnlPercentClass = position.unrealizedGainLossPercent >= 0 ? 'text-green-600' : 'text-red-600';

                    optionsBody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${position.symbol}</div>
                                <div class="text-sm text-gray-500">${position.symbolDescription || ''}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                ${position.quantity}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                $${position.currentPrice.toFixed(2)}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                $${position.marketValue.toFixed(2)}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm ${pnlClass}">
                                $${position.unrealizedGainLoss.toFixed(2)}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm ${pnlPercentClass}">
                                ${position.unrealizedGainLossPercent.toFixed(2)}%
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                <div class="flex justify-end gap-2">
                                    <button class="px-3 py-1 text-xs font-semibold text-white bg-red-600 hover:bg-red-700 rounded transition" data-symbol="${escapeHtml(position.symbol)}" data-option-symbol="${escapeHtml(position.symbol)}" data-quantity="${Number.isFinite(position.quantity) ? position.quantity : 0}" data-position-id="${escapeHtml(position.positionId || '')}" data-call-put="${escapeHtml(position.callPut || '')}" data-strike="${Number.isFinite(position.strike) ? position.strike : ''}" data-expiry="${escapeHtml(position.expiry || '')}" data-action="emergency-sell">
                                        Emergency Sell
                                    </button>
                                    <button class="px-3 py-1 text-xs font-medium text-blue-600 border border-blue-200 rounded hover:bg-blue-50 transition" data-symbol="${escapeHtml(position.symbol)}" data-action="manage-option">Manage</button>
                                    <button class="px-3 py-1 text-xs font-medium text-gray-600 border border-gray-200 rounded hover:bg-gray-50 transition" data-symbol="${escapeHtml(position.symbol)}" data-action="note-option">Add Note</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                optionsBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i data-lucide="zap" class="w-8 h-8 text-purple-400 mb-2"></i>
                                <div class="text-lg font-medium mb-2">No Options Positions</div>
                                <div class="text-sm text-center max-w-md">
                                    <div class="text-gray-400">No options positions found in this account.</div>
                                    <div class="text-xs text-gray-400 mt-2">Options positions will appear here when available.</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }

            // If no positions at all, show account info with balance data
            if ((!portfolio.positions || portfolio.positions.length === 0) && stocks.length === 0 && options.length === 0) {
                const fallbackBalanceDisplay = balanceData ? escapeHtml(getCurrencyString(Number(balanceData.totalAccountValue ?? 0))) : null;
                const fallbackCashDisplay = balanceData ? escapeHtml(getCurrencyString(Number(balanceData.moneyMktBalance ?? balanceData.cashAvailableForInvestment ?? 0))) : null;
                stocksBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i data-lucide="info" class="w-8 h-8 text-blue-400 mb-2"></i>
                                <div class="text-lg font-medium mb-2">Account Connected Successfully</div>
                                <div class="text-sm text-center max-w-md">
                                    <div class="mb-2">✅ <strong>Account:</strong> ${accountDetails?.accountDesc || 'Individual Brokerage'}</div>
                                    ${balanceData ? `
                                    <div class="mb-2">✅ <strong>Balance Available:</strong> ${fallbackBalanceDisplay}</div>
                                    <div class="mb-2">✅ <strong>Cash Available:</strong> ${fallbackCashDisplay}</div>
                                    ` : ''}
                                    <div class="mb-3">✅ <strong>Status:</strong> ${accountDetails?.accountStatus || 'ACTIVE'}</div>
                                    <div class="text-xs text-gray-400 bg-gray-100 p-2 rounded">
                                        <strong>Note:</strong> Portfolio details (positions) are not available through the E*TRADE API for this account type. ${balanceData ? 'Balance information is shown above.' : 'This is normal for many brokerage accounts.'}
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                optionsBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i data-lucide="info" class="w-8 h-8 text-blue-400 mb-2"></i>
                                <div class="text-lg font-medium mb-2">No Options Positions</div>
                                <div class="text-sm text-center max-w-md">
                                    <div class="text-gray-400">No options positions found in this account.</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }

            lucide.createIcons();
        }

        // Display basic account info when portfolio fails to load
        function displayBasicAccountInfo(accountDetails) {
            const safe = (value, fallback = '') => escapeHtml(value != null ? value : fallback);
            const accountIdDisplay = escapeHtml(getAccountIdString(accountDetails?.accountId || accountDetails?.accountIdKey || 'N/A'));
            lastPortfolioPayload = null;
            lastPortfolioBalance = null;
            accountSummary.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Account ID</div>
                    <div class="text-lg font-bold text-blue-600">${accountIdDisplay}</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Account Type</div>
                    <div class="text-lg font-bold text-green-600">${safe(accountDetails.accountType, 'INDIVIDUAL')}</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Account Mode</div>
                    <div class="text-lg font-bold text-purple-600">${safe(accountDetails.accountMode, 'CASH')}</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Status</div>
                    <div class="text-lg font-bold text-orange-600">${safe(accountDetails.accountStatus, 'ACTIVE')}</div>
                </div>
            `;

            stocksBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i data-lucide="info" class="w-8 h-8 text-blue-400 mb-2"></i>
                            <div class="text-lg font-medium mb-2">Account Connected Successfully</div>
                            <div class="text-sm text-center max-w-md">
                                <div class="mb-2">✅ <strong>Account:</strong> ${safe(accountDetails.accountDesc, 'Brokerage Account')}</div>
                                <div class="mb-2">✅ <strong>Type:</strong> ${safe(accountDetails.accountType, 'INDIVIDUAL')} (${safe(accountDetails.accountMode, 'CASH')})</div>
                                <div class="mb-2">✅ <strong>Status:</strong> ${safe(accountDetails.accountStatus, 'ACTIVE')}</div>
                                <div class="mb-3">✅ <strong>Institution:</strong> ${safe(accountDetails.institutionType, 'E*TRADE')}</div>
                                <div class="text-xs text-gray-400 bg-gray-100 p-2 rounded">
                                    <strong>Note:</strong> Portfolio details (balances, positions) are not available through the E*TRADE API for this account type. This is normal for many brokerage accounts.
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            optionsBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i data-lucide="info" class="w-8 h-8 text-blue-400 mb-2"></i>
                            <div class="text-lg font-medium mb-2">Account Connected Successfully</div>
                            <div class="text-sm text-center max-w-md">
                                <div class="text-gray-400">Portfolio details loaded for this account.</div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            lucide.createIcons();
        }

        async function loadScanConfig() {
            try {
                setSymbolsStatus('loading', 'Loading symbol list...');
                const response = await fetch('/api/scan/config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load configuration.');
                }
                applyScanConfig(data.config, { updateInput: true, updateStatus: true });
                if (symbolsInput) {
                    symbolsInput.value = currentSymbolList.join(', ');
                }
            } catch (error) {
                console.error('Failed to load scan config:', error);
                setSymbolsStatus('error', 'Unable to load symbol list');
            }
        }

        async function saveSymbols() {
            if (!symbolsInput || !saveSymbolsBtn) return;
            const normalized = normalizeSymbolInput(symbolsInput.value);
            if (normalized.length === 0) {
                setSymbolsStatus('warning', 'Enter at least one valid ticker symbol.');
                return;
            }
            if (normalized.length > 24) {
                setSymbolsStatus('warning', 'Please limit the list to 24 symbols.');
                return;
            }

            saveSymbolsBtn.disabled = true;
            saveSymbolsBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Saving...';
            lucide.createIcons();
            setSymbolsStatus('loading', 'Updating symbol list...');

            try {
                const response = await fetch('/api/scan/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: normalized })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to update symbol list.');
                }
                symbolsInput.value = normalized.join(', ');
                currentSymbolList = normalized;
                setSymbolsStatus('success', `Symbol list updated (${formatSymbolSummary(normalized)})`);
                applyScanConfig(data.config, { updateInput: false, updateStatus: false });
                await fetchRecommendations();
            } catch (error) {
                console.error('Symbol save failed:', error);
                setSymbolsStatus('error', error.message || 'Failed to update symbol list.');
            } finally {
                saveSymbolsBtn.disabled = false;
                saveSymbolsBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Save Symbols';
                lucide.createIcons();
            }
        }

        // Load initial data
        async function loadInitialData() {
            // Initialize header balance display
            updateHeaderBalance(null);
            updateScanStatus(null);
            await loadScanConfig();
            await fetchRecommendations();
            startRecommendationsPolling();
        }

        loadInitialData();
    </script>
</body>
</html>